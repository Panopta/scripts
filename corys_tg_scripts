# TG script to generate server report based on tags
server_types = ['solaris','aix','linux','windows']

for stype in server_types:
    for server in Server.selectBy(customerID=90005):
        if stype in [str(item).lower() for item in server.getTags()]:
            ip = None
            if server.getAdditionalFQDNs(): ip = str(server.getAdditionalFQDNs()[0])
            if 'default' in server.fqdn: continue
            print("%s,%s,%s" % (stype, str(server.fqdn), ip))

# TG script to delete ping checks for all servers in a group, text key can be substituted for anything we have
for i in Server.selectBy(server_group=274825):
    for j in i.monitor_points:
        if str(j.service_type.textkey) == 'icmp.ping': j.delete()

# TG Script to find users that are using a specific option of a specific agent check
count = 0
for server in ServerResource.selectBy(status='active', check_method='resource.agent.panopta'):
    check = server.loadMetadata()
    if 'cpu_usage' in check['plugin_textkey']:
        if "null" not in str(check['resource_option']) and "Total" not in str(check['resource_option']):
            count = count + 1
            print("Server with ID of %s is monitoring CPU percent on %s" % (str(server.ServerID),str(check['resource_option'])))
print("%s servers are monitoring specific CPUs!" % str(count))

# Cancel certain thresholds from certain templates on certain servers
debug = False
for server in Server_ServerTemplate.selectBy(server_template=(Server.get(661995))):
    for check in Server.get(server.serverID).server_resources:
        i = check.loadMetadata()
        if 'memory' in i['plugin_textkey'] or ('cpu' in i['plugin_textkey'] and 'load_average.5' in i['resource_textkey']) or ('cpu' in i['plugin_textkey'] and 'usage_percentage' in i['resource_textkey']):
            for t in check.thresholds:
                if debug == True:
                    print("%s - %s" % (server.serverID, check))
                else: t.cancel()


# Find customer account changes for servers with certain tags
tags_list = ['aix','oracle']

for i in CustomerLog.selectBy(customerID=90005):
    if "server" in str(i.target_type):
        try:
            server = Server.get(i.target_id)
            tags = [t.lower() for t in server.getTags()]
            if 'aix' in tags and 'oracle' in tags: print("%s,%s,%s"% (str(i.timestamp),str(server.name),str(i.message)))
        except: pass 

